#!/bin/bash

ROOT_DIR="$(cd "$(dirname "$0")"; pwd)"
PATH=/sbin:$PATH


do_status() {
	iptables -vL
	echo
	ip6tables -vL
}


do_clear() {
	# Reinitialisation des tables
	iptables -P   INPUT ACCEPT
	iptables -P  OUTPUT ACCEPT
	iptables -P FORWARD ACCEPT
	iptables -F
	iptables -X

	ip6tables -P   INPUT ACCEPT
	ip6tables -P  OUTPUT ACCEPT
	ip6tables -P FORWARD ACCEPT
	ip6tables -F
	ip6tables -X

	# ToDo : Clean chains one by one and keep Docker chain instead of flushing everything and restarting Docker Service
	#service docker   restart ; until iptables -L | grep -q DOCKER;   do sleep 1; done
}


do_start() {

	# Configuration
	###############################################################################
	which iptables &>/dev/null || exit 2
	which ipset    &>/dev/null || exit 3
	source "$ROOT_DIR/iptables.conf"
	[ -n "$NTWK_INTFCE" ] && [ -n "$TESTING" ] && [ -n "$TRUSTED_LST" ] && [ -n "$TRUSTED_ICMP" ] || exit 1


	# Default policies
	###############################################################################

	#IPv4
	iptables -P INPUT   DROP
	iptables -P OUTPUT  DROP
	iptables -P FORWARD DROP

	# IPv6
	ip6tables -P INPUT   DROP
	ip6tables -P OUTPUT  DROP
	ip6tables -P FORWARD DROP


	# Split TCP / UDP / ICMP
	###############################################################################

	# TCP
	iptables -N TCP_IN  ; iptables -m comment --comment "Split TCP   " -i $NTWK_INTFCE -A  INPUT -p tcp -j TCP_IN
	iptables -N TCP_OUT ; iptables -m comment --comment "Split TCP   " -o $NTWK_INTFCE -A OUTPUT -p tcp -j TCP_OUT

	# UDP
	iptables -N UDP_IN  ; iptables -m comment --comment "Split UDP   " -i $NTWK_INTFCE -A  INPUT -p udp -j UDP_IN
	iptables -N UDP_OUT ; iptables -m comment --comment "Split UDP   " -o $NTWK_INTFCE -A OUTPUT -p udp -j UDP_OUT


	# Security
	###############################################################################

	# Scans Xmas and Null
	for chain in TCP_IN FORWARD; do
		iptables -m comment --comment "Scans Xmas and Null" -I $chain 1 -p tcp --tcp-flags FIN,URG,PSH FIN,URG,PSH -j DROP
		iptables -m comment --comment "Scans Xmas and Null" -I $chain 1 -p tcp --tcp-flags ALL ALL                 -j DROP
		iptables -m comment --comment "Scans Xmas and Null" -I $chain 1 -p tcp --tcp-flags ALL NONE                -j DROP
		iptables -m comment --comment "Scans Xmas and Null" -I $chain 1 -p tcp --tcp-flags SYN,RST SYN,RST         -j DROP
	done

	# No broadcast and multicast
	for chain in INPUT FORWARD; do
		iptables -m comment --comment "No broadcast" -I $chain 1 -m pkttype --pkt-type broadcast -j DROP
		iptables -m comment --comment "No multicast" -I $chain 1 -m pkttype --pkt-type multicast -j DROP
	done

	# Blacklist
	ipset list | grep -q blacklist$ || do_blacklist_update
	for chain in INPUT OUTPUT FORWARD; do
		iptables -m comment --comment "BlackList   " -I $chain 1 -m set --match-set blacklist src,dst -j DROP
	done


	# Entrant
	###############################################################################

	ipset create trustedLst -exist hash:net family inet hashsize 16384 maxelem 10; ipset flush trustedLst
	for host in $TRUSTED_LST; do ipset add trustedLst $host; done

	# SSH port 443
	iptables -m comment --comment " IN SSH            " -A TCP_IN  -i $NTWK_INTFCE -p tcp --dport 443 -m set --match-set trustedLst src -j ACCEPT
	iptables -m comment --comment " IN SSH            " -A TCP_OUT -o $NTWK_INTFCE -p tcp --sport 443 -m set --match-set trustedLst dst -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

	# HTTP
#	iptables -m comment --comment " IN HTTP           " -A TCP_IN  -i $NTWK_INTFCE -p tcp --dport  80 -m set --match-set trustedLst src -j ACCEPT
#	iptables -m comment --comment " IN HTTP           " -A TCP_OUT -o $NTWK_INTFCE -p tcp --sport  80 -m set --match-set trustedLst dst -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

	# Transmission
#	iptables -m comment --comment " IN Transmission   " -A TCP_IN  -i $NTWK_INTFCE -p tcp --dport  9091 -j ACCEPT
#	iptables -m comment --comment " IN Transmission   " -A TCP_OUT -o $NTWK_INTFCE -p tcp --sport  9091 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
#	iptables -m comment --comment " IN Transmission   " -A TCP_IN  -i $NTWK_INTFCE -p tcp --dport 51413 -j ACCEPT
#	iptables -m comment --comment " IN Transmission   " -A TCP_OUT -o $NTWK_INTFCE -p tcp --sport 51413 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
#	iptables -m comment --comment " IN Transmission   " -A UDP_IN  -i $NTWK_INTFCE -p udp --dport 57379 -j ACCEPT
#	iptables -m comment --comment " IN Transmission   " -A UDP_OUT -o $NTWK_INTFCE -p udp --sport 57379 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
#	iptables -m comment --comment " IN Transmission   " -A UDP_IN  -i $NTWK_INTFCE -p udp --dport 60014 -j ACCEPT
#	iptables -m comment --comment " IN Transmission   " -A UDP_OUT -o $NTWK_INTFCE -p udp --sport 60014 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
#	iptables -m comment --comment " IN Transmission   " -A UDP_IN  -i $NTWK_INTFCE -p udp --dport 51413 -j ACCEPT
#	iptables -m comment --comment " IN Transmission   " -A UDP_OUT -o $NTWK_INTFCE -p udp --sport 51413 -j ACCEPT


	# Sortant
	###############################################################################

	# NTP
	iptables -m comment --comment "OUT NTP            " -o $NTWK_INTFCE -A UDP_OUT -p udp --dport  123 -j ACCEPT
	iptables -m comment --comment "OUT NTP            " -i $NTWK_INTFCE -A UDP_IN  -p udp --sport  123 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

	# DNS
	iptables -m comment --comment "OUT DNS            " -o $NTWK_INTFCE -A UDP_OUT -p udp --dport   53 -j ACCEPT
	iptables -m comment --comment "OUT DNS            " -i $NTWK_INTFCE -A UDP_IN  -p udp --sport   53 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

	# HTTP
	iptables -m comment --comment "OUT HTTP           " -o $NTWK_INTFCE -A TCP_OUT -p tcp --dport   80 -j ACCEPT
	iptables -m comment --comment "OUT HTTP           " -i $NTWK_INTFCE -A TCP_IN  -p tcp --sport   80 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

	# HTTPS
	iptables -m comment --comment "OUT HTTPS          " -o $NTWK_INTFCE -A TCP_OUT -p tcp --dport  443 -j ACCEPT
	iptables -m comment --comment "OUT HTTPS          " -i $NTWK_INTFCE -A TCP_IN  -p tcp --sport  443 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

	# SMTP
	iptables -m comment --comment "OUT SMTP           " -o $NTWK_INTFCE -A TCP_OUT -p tcp --dport   25 -j ACCEPT
	iptables -m comment --comment "OUT SMTP           " -i $NTWK_INTFCE -A TCP_IN  -p tcp --sport   25 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

	# Whois
	iptables -m comment --comment "OUT Whois          " -o $NTWK_INTFCE -A TCP_OUT -p tcp --dport   43 -j ACCEPT
	iptables -m comment --comment "OUT Whois          " -i $NTWK_INTFCE -A TCP_IN  -p tcp --sport   43 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
	iptables -m comment --comment "OUT Whois          " -o $NTWK_INTFCE -A TCP_OUT -p tcp --dport 4321 -j ACCEPT
	iptables -m comment --comment "OUT Whois          " -i $NTWK_INTFCE -A TCP_IN  -p tcp --sport 4321 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

	# SSH
	iptables -m comment --comment "OUT SSH            " -o $NTWK_INTFCE -A TCP_OUT -p tcp --dport   22 -j ACCEPT
	iptables -m comment --comment "OUT SSH            " -i $NTWK_INTFCE -A TCP_IN  -p tcp --sport   22 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT


	# ICMP - Ping OVH
	###############################################################################

	ipset create icmp -exist hash:net family inet hashsize 16384 maxelem 10; ipset flush icmp
	for source in $TRUSTED_ICMP; do ipset add icmp $source; done
	iptables -m comment --comment "ICMP        " -i $NTWK_INTFCE -A INPUT  -p icmp -m set --match-set icmp src -j ACCEPT
	iptables -m comment --comment "ICMP        " -o $NTWK_INTFCE -A OUTPUT -p icmp -m set --match-set icmp dst -j ACCEPT


	# Logs
	###############################################################################

	# Depollueurs
	iptables -m comment --comment "NO_LOG_POLLUTION:Port  21" -A INPUT -p tcp --dport  21 -j DROP
	iptables -m comment --comment "NO_LOG_POLLUTION:Port  23" -A INPUT -p tcp --dport  23 -j DROP
	iptables -m comment --comment "NO_LOG_POLLUTION:Port  80" -A INPUT -p tcp --dport  80 -j DROP
	iptables -m comment --comment "NO_LOG_POLLUTION:Port 443" -A INPUT -p tcp --dport 443 -j DROP

	# Logs
	iptables -m comment --comment "Logs                     " -A INPUT  -j LOG --log-prefix " [INPUT DROPPED] "
	iptables -m comment --comment "Logs        "              -A OUTPUT -j LOG --log-prefix "[OUTPUT DROPPED] "
}


do_monitor() {
	iptables -Z
	local begin="$(date +%s)"
	while sleep 60; do
		clear
		printf 'Depuis '; date -d "@$(($(date +%s) - $begin))" --utc '+%H:%M'
		iptables -nvL
	done
}


do_blacklist_update() {
	ipset create blacklist-tmp -exist hash:net family inet hashsize 16384 maxelem 131072

	{
		sed 's/#.*//g;/^$/d' "$ROOT_DIR/blacklist-sources.list" | while read src; do
			wget -O- -o/dev/null "$src" | grep -Po '(?:\d{1,3}\.){3}\d{1,3}(?:/\d{1,2})?' | sed 's/#.*//g;/^$/d' | sed -r -e '/^(10\.|127\.|172\.16\.|192\.168\.)/d'
		done
		sed 's/#.*//g;/^$/d' "$ROOT_DIR/blacklist"
	} | sort -u | while read ipaddr; do
	    	ipset add blacklist-tmp $ipaddr
	    done

	ipset create blacklist -exist hash:net family inet hashsize 16384 maxelem 131072
	ipset swap   blacklist blacklist-tmp
	ipset destroy blacklist-tmp
}


do_blacklist_add() {
	for IP in $@; do
		ipset list blacklist | grep -q $IP || ipset add blacklist $IP
		grep -q $IP "$ROOT_DIR/blacklist"  || echo $IP >>"$ROOT_DIR/blacklist"
	done
}


###############################################################################
# Main
###############################################################################


[ "$1" == 'blupd' ] && {
	do_blacklist_update
	exit 0
}

[ "$1" == 'status' ] && {
	do_status
	exit 0
}

[ "$1" == 'monitor' ] && {
	do_monitor
	exit 0
}

[ "$1" == 'stop' ] && {
	do_clear
	exit 0
}


[ "$1" == 'bladd' ] && {
	shift
	do_blacklist_add $@
	exit 0
}

[ "$1" == 'start' ] && {
	do_clear
	do_start

	[ "$2" == 'notest' ] && exit 0
	$TESTING || exit 0

	do_status
	echo
	echo "La configuration sera annulée dans 60 secondes."
	echo "Appuyer sur CTRL-C pour l'appliquer définitivement..."

	sleep 60
	do_clear
}
